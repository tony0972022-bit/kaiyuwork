<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>通勤生活助理</title>
  <!-- 引入 Tailwind CSS (樣式) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 Babel (讓瀏覽器看懂 React) - 指定版本以確保穩定性 -->
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  
  <style>
    /* 隱藏滾動條但保留功能 */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    /* 為了手機版優化的安全距離 */
    .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
    }
    @keyframes bounce-in {
      0% { opacity: 0; transform: translate(-50%, -20px); }
      100% { opacity: 1; transform: translate(-50%, 0); }
    }
    .animate-bounce-in {
      animation: bounce-in 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <!-- 主程式邏輯 - 加入 data-presets="react" 解決編譯錯誤 -->
  <script type="text/babel" data-type="module" data-presets="react">
    // 透過網路引用 React 和相關套件
    import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    
    // 引入圖示庫
    import { 
      Train, Bike, Car, MapPin, LayoutDashboard, CalendarCheck, MessageSquare, Wallet, Settings, 
      Plus, Trash2, TrendingUp, Save, CheckCircle, Circle, Target, Clock, DollarSign, 
      PieChart as PieChartIcon, Camera, Upload, ArrowRight, Home, Building2, ChevronRight, 
      MoreHorizontal, User, Play, StopCircle, Bell, Loader, Calendar as CalendarIcon, 
      Sun, CloudRain, Cloud, Wind, ChevronLeft, ChevronRight as ChevronRightIcon, 
      AlertTriangle, LogOut 
    } from 'https://esm.sh/lucide-react@0.292.0';

    // 引入圖表庫
    import { 
      BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
      PieChart, Pie, Cell, LineChart, Line
    } from 'https://esm.sh/recharts@2.10.3';

    // 引入 Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, deleteDoc, updateDoc, 
      query, orderBy, limit, where 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // --- 設定區 ---

    // 您的 Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB5OHow6gAbMNwGDEZ4FH1Aemj5DKBM5sY",
      authDomain: "kaiyu-work.firebaseapp.com",
      projectId: "kaiyu-work",
      storageBucket: "kaiyu-work.firebasestorage.app",
      messagingSenderId: "11801116898",
      appId: "1:11801116898:web:b3f70e639ce84ba3851ebb",
      measurementId: "G-6K1C2SCRYK"
    };

    // 台灣國定假日
    const TAIWAN_HOLIDAYS = {
      '2025-01-01': '元旦',
      '2025-01-25': '春節', '2025-01-26': '春節', '2025-01-27': '春節',
      '2025-01-28': '春節', '2025-01-29': '春節', '2025-01-30': '春節',
      '2025-02-28': '228',
      '2025-04-04': '兒童節', '2025-04-05': '清明節',
      '2025-05-31': '端午節',
      '2025-10-06': '中秋節',
      '2025-10-10': '國慶日',
    };

    // --- 輔助函式 ---
    const formatTime = (timestamp) => {
      if (!timestamp) return null;
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
    };

    const getTodayString = () => new Date().toISOString().split('T')[0];

    const getDayOfWeek = (dateStr) => {
      const days = ['日', '一', '二', '三', '四', '五', '六'];
      return days[new Date(dateStr).getDay()];
    };

    // --- UI 元件 ---

    const Card = ({ children, className = "", title, action }) => (
      <div className={`bg-white rounded-xl shadow-sm border border-slate-100 p-4 ${className}`}>
        {(title || action) && (
          <div className="flex justify-between items-center mb-4">
            {title && <h3 className="font-bold text-slate-800 text-lg">{title}</h3>}
            {action}
          </div>
        )}
        {children}
      </div>
    );

    const Button = ({ children, onClick, variant = 'primary', className = "", disabled=false, size='md' }) => {
      const baseStyle = "rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2";
      const sizes = { sm: "px-3 py-1.5 text-xs", md: "px-4 py-2 text-sm", lg: "px-6 py-3 text-base" };
      const variants = {
        primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-md shadow-indigo-200",
        secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50",
        danger: "bg-red-50 text-red-600 hover:bg-red-100",
        ghost: "text-slate-500 hover:bg-slate-100"
      };
      return (
        <button 
          onClick={onClick} disabled={disabled}
          className={`${baseStyle} ${sizes[size]} ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
        >
          {children}
        </button>
      );
    };

    const Toast = ({ message, onClose }) => {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);
      if (!message) return null;
      return (
        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg z-[100] flex items-center gap-2 animate-bounce-in">
          <CheckCircle size={16} className="text-emerald-400" />
          <span className="text-sm font-medium">{message}</span>
        </div>
      );
    };

    const LoginView = ({ onLogin }) => (
      <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 p-6">
        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
          <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600">
            <User size={40} />
          </div>
          <h1 className="text-2xl font-bold text-slate-800 mb-2">歡迎回來</h1>
          <p className="text-slate-500 mb-8">請登入以同步您的通勤與生活紀錄</p>
          <Button onClick={onLogin} className="w-full py-3 text-lg shadow-indigo-200/50 flex items-center justify-center gap-3">
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
            使用 Google 帳號登入
          </Button>
          <p className="text-xs text-slate-400 mt-6">資料將安全儲存於您的雲端資料庫</p>
        </div>
      </div>
    );

    const WeatherWidget = () => {
      const today = new Date();
      const dateStr = `${today.getMonth() + 1}/${today.getDate()} (${getDayOfWeek(today)})`;
      return (
        <Card className="bg-gradient-to-br from-blue-500 to-blue-600 text-white border-none overflow-hidden relative">
          <div className="flex justify-between items-start mb-4 relative z-10">
            <div>
              <h3 className="font-bold text-lg">天氣預報</h3>
              <p className="text-blue-100 text-sm">{dateStr}</p>
            </div>
            <Cloud className="text-blue-200 opacity-50 absolute -right-4 -top-4" size={80} />
          </div>
          <div className="grid grid-cols-2 gap-4 relative z-10 divide-x divide-blue-400/30">
            <div className="flex flex-col items-center">
              <span className="text-xs text-blue-100 mb-1">台南市</span>
              <Sun className="text-yellow-300 mb-1" size={28} />
              <span className="font-bold text-xl">28°C</span>
              <span className="text-xs text-blue-100">晴時多雲</span>
            </div>
            <div className="flex flex-col items-center">
              <span className="text-xs text-blue-100 mb-1">高雄市</span>
              <CloudRain className="text-blue-200 mb-1" size={28} />
              <span className="font-bold text-xl">29°C</span>
              <span className="text-xs text-blue-100">午後陣雨</span>
            </div>
          </div>
        </Card>
      );
    };

    // --- 子頁面元件 ---

    const DashboardView = ({ timeline, user, todos, financeSummary, setActiveTab, onLogout }) => (
      <div className="space-y-6 pb-20">
        <header className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-slate-800">早安</h1>
            <p className="text-sm text-slate-500">{getTodayString()} • {user.displayName || "使用者"}</p>
          </div>
          <div className="flex items-center gap-2">
            <div className="relative group">
              {user.photoURL ? (
                <img src={user.photoURL} alt="User" className="h-10 w-10 rounded-full border-2 border-indigo-200 cursor-pointer" onClick={onLogout} title="點擊登出" />
              ) : (
                <div className="h-10 w-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold border-2 border-indigo-200 cursor-pointer" onClick={onLogout}>
                  {user.displayName ? user.displayName[0].toUpperCase() : "U"}
                </div>
              )}
            </div>
          </div>
        </header>
        <WeatherWidget />
        <Card className="bg-white border-l-4 border-indigo-500">
          <h3 className="text-slate-500 text-xs mb-1 font-bold uppercase tracking-wider">今日狀態</h3>
          <div className="flex items-end justify-between">
            <div>
              <div className="text-2xl font-bold text-slate-800">
                {timeline.step5_arriveOffice ? "辦公中" : timeline.step1_leaveHome ? "通勤中" : "準備出發"}
              </div>
              <p className="text-slate-500 text-sm mt-1">
                {timeline.step5_arriveOffice ? `於 ${formatTime(timeline.step5_arriveOffice)} 抵達` : "尚未抵達辦公室"}
              </p>
            </div>
            <div className="bg-indigo-50 p-2 rounded-full text-indigo-600"><Clock size={24} /></div>
          </div>
        </Card>
        <div className="grid grid-cols-2 gap-4">
          <button onClick={() => setActiveTab('todo')} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center justify-center gap-2 hover:bg-slate-50 transition-colors">
            <div className="bg-orange-100 p-2 rounded-full text-orange-600"><CalendarCheck size={20} /></div>
            <span className="font-medium text-slate-700">待辦 ({todos.filter(t=>!t.completed).length})</span>
          </button>
          <button onClick={() => setActiveTab('finance')} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center justify-center gap-2 hover:bg-slate-50 transition-colors">
            <div className="bg-emerald-100 p-2 rounded-full text-emerald-600"><Wallet size={20} /></div>
            <span className="font-medium text-slate-700">記帳</span>
          </button>
        </div>
      </div>
    );

    const TimelineItem = ({ icon: Icon, label, time, onClick, color, subtext }) => (
      <div className="flex gap-4 relative z-10">
        <div className="flex flex-col items-center">
          <button onClick={onClick} className={`w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md transition-all active:scale-95 ${time ? color : 'bg-slate-200 text-slate-400'}`}>
            <Icon size={18} />
          </button>
        </div>
        <div className="pb-6 flex-1 pt-1">
          <div className="flex justify-between items-start">
            <div><h4 className={`font-bold ${time ? 'text-slate-800' : 'text-slate-400'}`}>{label}</h4>{subtext && <p className="text-xs text-slate-400 mt-0.5">{subtext}</p>}</div>
            {time ? <span className="text-sm font-mono font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">{time}</span> : <button onClick={onClick} className="text-xs text-slate-400 border border-slate-200 px-2 py-1 rounded hover:bg-slate-50">打卡</button>}
          </div>
        </div>
      </div>
    );

    const CommuteView = ({ timeline, handleCheckpoint }) => {
      const getStatus = (key) => timeline[key] ? formatTime(timeline[key]) : null;
      return (
        <div className="space-y-6 pb-20">
          <header>
            <h2 className="text-xl font-bold text-slate-800">今日通勤</h2>
            <p className="text-sm text-slate-500">只顯示當天紀錄，歷史請見日曆</p>
          </header>
          <Card className="relative overflow-hidden">
            <div className="absolute left-6 top-6 bottom-6 w-0.5 bg-slate-200"></div>
            <div className="space-y-6 relative">
              <div className="bg-slate-50 p-2 rounded-lg mb-4 text-center font-bold text-slate-600 text-sm">去程</div>
              <TimelineItem icon={Home} label="離開家裡" time={getStatus('step1_leaveHome')} onClick={() => handleCheckpoint('step1_leaveHome', '離開家裡')} color="bg-slate-500" />
              <TimelineItem icon={Train} label="抵達台南火車站" time={getStatus('step2_arriveTainan')} onClick={() => handleCheckpoint('step2_arriveTainan', '抵達台南火車站')} color="bg-orange-500" />
              <TimelineItem icon={Train} label="抵達高雄火車站" time={getStatus('step3_arriveKaohsiung')} onClick={() => handleCheckpoint('step3_arriveKaohsiung', '抵達高雄火車站')} color="bg-indigo-500" />
              <TimelineItem icon={Bike} label="離開高雄火車站" time={getStatus('step4_leaveKaohsiung')} onClick={() => handleCheckpoint('step4_leaveKaohsiung', '離開高雄火車站')} color="bg-indigo-500" />
              <TimelineItem icon={Building2} label="抵達辦公室" time={getStatus('step5_arriveOffice')} onClick={() => handleCheckpoint('step5_arriveOffice', '抵達辦公室')} color="bg-emerald-500" />
              <div className="bg-slate-50 p-2 rounded-lg my-4 text-center font-bold text-slate-600 text-sm">回程</div>
              <TimelineItem icon={Building2} label="離開辦公室" time={getStatus('step6_leaveOffice')} onClick={() => handleCheckpoint('step6_leaveOffice', '離開辦公室')} color="bg-emerald-500" />
              <TimelineItem icon={Train} label="抵達高雄火車站" time={getStatus('step7_arriveKaohsiung_Return')} onClick={() => handleCheckpoint('step7_arriveKaohsiung_Return', '抵達高雄火車站')} color="bg-indigo-500" />
              <TimelineItem icon={Train} label="抵達台南火車站" time={getStatus('step8_arriveTainan_Return')} onClick={() => handleCheckpoint('step8_arriveTainan_Return', '抵達台南火車站')} color="bg-orange-500" />
              <TimelineItem icon={Home} label="抵達家裡" time={getStatus('step9_arriveHome')} onClick={() => handleCheckpoint('step9_arriveHome', '抵達家裡')} color="bg-slate-500" />
            </div>
          </Card>
        </div>
      );
    };

    const CalendarView = ({ db, user, appId }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [monthlyData, setMonthlyData] = useState({});
      useEffect(() => {
        if (!user || !db) return;
        const fetchMonth = async () => {
          const year = currentDate.getFullYear();
          const month = String(currentDate.getMonth() + 1).padStart(2, '0');
          const prefix = `${year}-${month}`;
          const commuteRef = collection(db, 'artifacts', appId, `users/${user.uid}`, 'commute_days');
          const unsub = onSnapshot(query(commuteRef), (snapshot) => {
            const data = {};
            snapshot.docs.forEach(doc => { if (doc.id.startsWith(prefix)) data[doc.id] = { ...data[doc.id], commute: doc.data() }; });
            const financeRef = collection(db, 'artifacts', appId, `users/${user.uid}`, 'transactions');
            onSnapshot(query(financeRef), (txSnap) => {
              txSnap.docs.forEach(doc => {
                const tx = doc.data();
                if (tx.date.startsWith(prefix)) {
                  if (!data[tx.date]) data[tx.date] = {};
                  if (!data[tx.date].finance) data[tx.date].finance = 0;
                  data[tx.date].finance += (tx.type === 'income' ? tx.amount : -tx.amount);
                }
              });
              setMonthlyData(data);
            });
          });
          return () => unsub(); 
        };
        fetchMonth();
      }, [currentDate, user, db]);

      const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
      const changeMonth = (delta) => { const newDate = new Date(currentDate); newDate.setMonth(newDate.getMonth() + delta); setCurrentDate(newDate); };
      const renderCells = () => {
        const cells = [];
        for (let i = 0; i < firstDay; i++) cells.push(<div key={`empty-${i}`} className="h-24 bg-slate-50/50"></div>);
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const dayData = monthlyData[dateStr] || {};
          const isWeekend = new Date(dateStr).getDay() === 0 || new Date(dateStr).getDay() === 6;
          const isHoliday = TAIWAN_HOLIDAYS[dateStr];
          const isToday = dateStr === getTodayString();
          const startWork = dayData.commute?.step5_arriveOffice ? formatTime(dayData.commute.step5_arriveOffice) : null;
          const endWork = dayData.commute?.step6_leaveOffice ? formatTime(dayData.commute.step6_leaveOffice) : null;
          const balance = dayData.finance;
          cells.push(
            <div key={d} className={`h-28 border border-slate-100 p-1 flex flex-col justify-between ${isToday ? 'bg-indigo-50 border-indigo-200' : 'bg-white'}`}>
              <div className="flex justify-between items-start">
                <span className={`text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-indigo-600 text-white' : (isWeekend || isHoliday ? 'text-red-500' : 'text-slate-700')}`}>{d}</span>
                {isHoliday && <span className="text-[10px] bg-red-100 text-red-600 px-1 rounded">{isHoliday}</span>}
              </div>
              <div className="flex-1 flex flex-col justify-center gap-0.5 mt-1">
                {startWork && <div className="text-[10px] text-slate-500 flex items-center gap-1"><div className="w-1.5 h-1.5 rounded-full bg-emerald-400"></div> {startWork} 上</div>}
                {endWork && <div className="text-[10px] text-slate-500 flex items-center gap-1"><div className="w-1.5 h-1.5 rounded-full bg-orange-400"></div> {endWork} 下</div>}
                {(!startWork && !endWork && !isWeekend && !isHoliday) && <div className="text-[10px] text-slate-300 text-center">-</div>}
              </div>
              {balance !== undefined && balance !== 0 && <div className={`text-[10px] font-bold text-right px-1 rounded ${balance > 0 ? 'text-emerald-600 bg-emerald-50' : 'text-red-600 bg-red-50'}`}>{balance > 0 ? '+' : ''}{balance}</div>}
            </div>
          );
        }
        return cells;
      };
      return (
        <div className="space-y-4 pb-20">
          <header className="flex items-center justify-between">
            <h2 className="text-xl font-bold text-slate-800">歷史日曆</h2>
            <div className="flex items-center gap-2 bg-white rounded-lg p-1 border border-slate-200 shadow-sm">
              <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-slate-100 rounded"><ChevronLeft size={20} /></button>
              <span className="text-sm font-bold min-w-[100px] text-center">{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</span>
              <button onClick={() => changeMonth(1)} className="p-1 hover:bg-slate-100 rounded"><ChevronRightIcon size={20} /></button>
            </div>
          </header>
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div className="grid grid-cols-7 border-b border-slate-200 bg-slate-50">
              {['日', '一', '二', '三', '四', '五', '六'].map((day, i) => <div key={day} className={`text-center py-2 text-xs font-bold ${i === 0 || i === 6 ? 'text-red-500' : 'text-slate-600'}`}>{day}</div>)}
            </div>
            <div className="grid grid-cols-7">{renderCells()}</div>
          </div>
          <div className="flex gap-4 text-xs text-slate-500 px-2">
             <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-emerald-400"></div>上班打卡</div>
             <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-orange-400"></div>下班打卡</div>
          </div>
        </div>
      );
    };

    const TodoView = ({ todos, addTodo, toggleTodo, deleteTodo, newTodo, setNewTodo }) => (
      <div className="space-y-6 pb-20">
        <header className="flex justify-between items-center"><h2 className="text-xl font-bold text-slate-800">每日待辦</h2><Button size="sm" onClick={addTodo}>新增</Button></header>
        <div className="bg-white p-2 rounded-xl shadow-sm border border-slate-100 flex gap-2"><input type="text" value={newTodo} onChange={(e) => setNewTodo(e.target.value)} placeholder="輸入新任務..." className="flex-1 p-2 outline-none text-sm"/></div>
        <div className="space-y-2">
          {todos.map(todo => (
            <div key={todo.id} className={`bg-white p-3 rounded-xl border border-slate-100 flex items-center gap-3 transition-all ${todo.completed ? 'opacity-60' : ''}`}>
              <button onClick={() => toggleTodo(todo)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${todo.completed ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300'}`}>{todo.completed && <CheckCircle size={14} className="text-white" />}</button>
              <div className="flex-1"><p className={`text-sm ${todo.completed ? 'line-through text-slate-400' : 'text-slate-800'}`}>{todo.text}</p></div>
              <button onClick={() => deleteTodo(todo.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={16} /></button>
            </div>
          ))}
        </div>
      </div>
    );

    const FinanceView = ({ transactions, financeInput, setFinanceInput, addTransaction, financeSummary }) => (
      <div className="space-y-6 pb-20">
        <header><h2 className="text-xl font-bold text-slate-800">收支記帳</h2></header>
        <div className="grid grid-cols-2 gap-4">
          <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100"><p className="text-xs text-emerald-600 font-bold uppercase">本月收入</p><p className="text-2xl font-bold text-emerald-700 mt-1">${financeSummary.income.toLocaleString()}</p></div>
          <div className="bg-red-50 p-4 rounded-xl border border-red-100"><p className="text-xs text-red-600 font-bold uppercase">本月支出</p><p className="text-2xl font-bold text-red-700 mt-1">${financeSummary.expense.toLocaleString()}</p></div>
        </div>
        <Card title="新增記帳">
          <div className="flex gap-2 mb-4">
              <button onClick={() => setFinanceInput({...financeInput, type: 'expense'})} className={`flex-1 py-2 rounded-lg text-sm font-bold ${financeInput.type === 'expense' ? 'bg-red-500 text-white' : 'bg-slate-100 text-slate-500'}`}>支出</button>
              <button onClick={() => setFinanceInput({...financeInput, type: 'income'})} className={`flex-1 py-2 rounded-lg text-sm font-bold ${financeInput.type === 'income' ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-500'}`}>收入</button>
          </div>
          <div className="space-y-3">
            <div className="flex gap-2"><input type="number" placeholder="金額" value={financeInput.amount} onChange={(e) => setFinanceInput({...financeInput, amount: e.target.value})} className="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none" /></div>
            <div className="flex gap-2"><select className="w-1/3 p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none" value={financeInput.category} onChange={(e) => setFinanceInput({...financeInput, category: e.target.value})}><option>餐飲</option><option>交通</option><option>購物</option><option>娛樂</option><option>薪資</option><option>其他</option></select><input type="text" placeholder="備註" value={financeInput.note} onChange={(e) => setFinanceInput({...financeInput, note: e.target.value})} className="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none text-sm" /></div>
            <Button className="w-full mt-2" onClick={addTransaction}><CheckCircle size={18} /> 儲存</Button>
          </div>
        </Card>
        <div className="space-y-3">
          {transactions.map(t => (
            <div key={t.id} className="bg-white p-3 rounded-lg border border-slate-100 flex justify-between items-center">
              <div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-full flex items-center justify-center ${t.type === 'expense' ? 'bg-red-50 text-red-500' : 'bg-emerald-50 text-emerald-500'}`}><DollarSign size={18} /></div><div><div className="font-bold text-slate-700">{t.category}</div><div className="text-xs text-slate-400">{t.note} • {t.date}</div></div></div>
              <div className={`font-bold ${t.type === 'expense' ? 'text-slate-800' : 'text-emerald-600'}`}>{t.type === 'expense' ? '-' : '+'}{t.amount}</div>
            </div>
          ))}
        </div>
      </div>
    );

    const PlanView = ({ yearlyScript, setYearlyScript, saveGoals }) => (
      <div className="space-y-6 pb-20 h-full flex flex-col">
        <header className="flex-shrink-0"><h2 className="text-xl font-bold text-slate-800">人生規劃</h2></header>
        <Card className="flex-shrink-0">
          <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-slate-800">年度目標腳本</h3><Button size="sm" variant="ghost" onClick={saveGoals}><Save size={16} /> 儲存</Button></div>
          <textarea className="w-full h-40 p-3 bg-amber-50 border border-amber-100 rounded-lg text-sm leading-relaxed outline-none resize-none text-slate-700" value={yearlyScript} onChange={(e) => setYearlyScript(e.target.value)} placeholder="寫下你的目標..." />
        </Card>
      </div>
    );

    const TabBar = ({ activeTab, setActiveTab }) => {
      const tabs = [
        { id: 'dashboard', icon: LayoutDashboard, label: '總覽' },
        { id: 'commute', icon: Train, label: '通勤' },
        { id: 'calendar', icon: CalendarIcon, label: '日曆' },
        { id: 'todo', icon: CalendarCheck, label: '待辦' },
        { id: 'finance', icon: Wallet, label: '記帳' },
        { id: 'plan', icon: Target, label: '規劃' },
      ];
      return (
        <nav className="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 px-2 py-2 pb-safe flex justify-between items-center z-50 md:relative md:border-t-0 overflow-x-auto scrollbar-hide">
          {tabs.map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1 min-w-[50px] p-2 rounded-xl transition-colors ${activeTab === tab.id ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400 hover:bg-slate-50'}`}>
              <tab.icon size={20} strokeWidth={activeTab === tab.id ? 2.5 : 2} />
              <span className="text-[9px] font-medium whitespace-nowrap">{tab.label}</span>
            </button>
          ))}
        </nav>
      );
    };

    // --- 主程式 (App) ---

    function App() {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [notification, setNotification] = useState(null);
      const [user, setUser] = useState(null);
      const [db, setDb] = useState(null);
      const [loading, setLoading] = useState(true);
      const [timeline, setTimeline] = useState({});
      const [todos, setTodos] = useState([]);
      const [transactions, setTransactions] = useState([]);
      const [yearlyScript, setYearlyScript] = useState("");
      const [newTodo, setNewTodo] = useState("");
      const [financeInput, setFinanceInput] = useState({ amount: '', note: '', category: '餐飲', type: 'expense' });
      const appId = 'default-app-id';

      // 初始化 Firebase
      useEffect(() => {
        try {
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);
          const dbInstance = getFirestore(app);
          setDb(dbInstance);

          const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            setUser(currentUser);
            setLoading(false);
          });
          return () => unsubscribe();
        } catch (err) {
          console.error("Initialization Error:", err);
          setLoading(false);
        }
      }, []);

      // 資料監聽
      useEffect(() => {
        if (!user || !db) return;
        const userPath = `users/${user.uid}`;
        const todayStr = getTodayString();
        const unsubTimeline = onSnapshot(doc(db, 'artifacts', appId, userPath, 'commute_days', todayStr), (docSnap) => setTimeline(docSnap.exists() ? docSnap.data() : {}));
        const unsubTodos = onSnapshot(collection(db, 'artifacts', appId, userPath, 'todos'), (snapshot) => setTodos(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt - a.createdAt)));
        const unsubFinance = onSnapshot(collection(db, 'artifacts', appId, userPath, 'transactions'), (snapshot) => setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.date.localeCompare(a.date))));
        const unsubGoals = onSnapshot(doc(db, 'artifacts', appId, userPath, 'settings', 'goals'), (docSnap) => { if(docSnap.exists()) setYearlyScript(docSnap.data().text || ""); });
        return () => { unsubTimeline(); unsubTodos(); unsubFinance(); unsubGoals(); };
      }, [user, db]);

      // 事件處理
      const handleGoogleLogin = async () => {
        const auth = getAuth();
        try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { alert("登入失敗: " + error.message); }
      };
      const handleLogout = () => signOut(getAuth());
      const handleCheckpoint = async (stepKey, label) => {
        if (!user || !db) return;
        await setDoc(doc(db, 'artifacts', appId, `users/${user.uid}`, 'commute_days', getTodayString()), { [stepKey]: new Date().toISOString(), lastUpdated: new Date().toISOString() }, { merge: true });
        setNotification(`${label} 打卡成功`);
      };
      const addTodo = async () => { if (!newTodo.trim()) return; await addDoc(collection(db, 'artifacts', appId, `users/${user.uid}`, 'todos'), { text: newTodo, completed: false, tag: "一般", createdAt: Date.now() }); setNewTodo(""); };
      const toggleTodo = async (todo) => updateDoc(doc(db, 'artifacts', appId, `users/${user.uid}`, 'todos', todo.id), { completed: !todo.completed });
      const deleteTodo = async (id) => deleteDoc(doc(db, 'artifacts', appId, `users/${user.uid}`, 'todos', id));
      const addTransaction = async () => { if (!financeInput.amount) return; await addDoc(collection(db, 'artifacts', appId, `users/${user.uid}`, 'transactions'), { date: getTodayString(), amount: Number(financeInput.amount), category: financeInput.category, note: financeInput.note, type: financeInput.type, createdAt: Date.now() }); setFinanceInput({ amount: '', note: '', category: '餐飲', type: 'expense' }); setNotification("記帳成功"); };
      const saveGoals = async () => { await setDoc(doc(db, 'artifacts', appId, `users/${user.uid}`, 'settings', 'goals'), { text: yearlyScript, updatedAt: Date.now() }, { merge: true }); setNotification("目標腳本已儲存"); };
      
      const financeSummary = useMemo(() => transactions.reduce((acc, curr) => { if (curr.type === 'income') acc.income += curr.amount; if (curr.type === 'expense') acc.expense += curr.amount; return acc; }, { income: 0, expense: 0 }), [transactions]);

      // URL 自動打卡偵測
      useEffect(() => {
        if (!user || !db) return;
        const params = new URLSearchParams(window.location.search);
        const act = params.get('act');
        if (act) {
          const stepMap = { '1': { key: 'step1_leaveHome', label: '離開家裡' }, '2': { key: 'step2_arriveTainan', label: '抵達台南火車站' }, '3': { key: 'step3_arriveKaohsiung', label: '抵達高雄火車站' }, '4': { key: 'step4_leaveKaohsiung', label: '離開高雄火車站' }, '5': { key: 'step5_arriveOffice', label: '抵達辦公室' }, '6': { key: 'step6_leaveOffice', label: '離開辦公室' }, '7': { key: 'step7_arriveKaohsiung_Return', label: '抵達高雄火車站(回)' }, '8': { key: 'step8_arriveTainan_Return', label: '抵達台南火車站(回)' }, '9': { key: 'step9_arriveHome', label: '抵達家裡' } };
          const target = stepMap[act];
          if (target) { handleCheckpoint(target.key, target.label); setActiveTab('commute'); }
        }
      }, [user, db]);

      if (loading) return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-400"><Loader className="animate-spin mb-2" /><p className="text-sm">資料連線中...</p></div>;
      if (!user) return <LoginView onLogin={handleGoogleLogin} />;

      return (
        <div className="min-h-screen bg-slate-50 font-sans text-slate-900 md:pb-0 relative flex justify-center">
          <div className="w-full max-w-md bg-white min-h-screen shadow-2xl relative flex flex-col">
            <Toast message={notification} onClose={() => setNotification(null)} />
            <div className="flex-1 overflow-y-auto p-5 scrollbar-hide pb-24">
              {activeTab === 'dashboard' && <DashboardView timeline={timeline} user={user} todos={todos} financeSummary={financeSummary} setActiveTab={setActiveTab} onLogout={handleLogout} />}
              {activeTab === 'commute' && <CommuteView timeline={timeline} handleCheckpoint={handleCheckpoint} />}
              {activeTab === 'calendar' && <CalendarView db={db} user={user} appId={appId} />}
              {activeTab === 'todo' && <TodoView todos={todos} addTodo={addTodo} toggleTodo={toggleTodo} deleteTodo={deleteTodo} newTodo={newTodo} setNewTodo={setNewTodo} />}
              {activeTab === 'finance' && <FinanceView transactions={transactions} financeInput={financeInput} setFinanceInput={setFinanceInput} addTransaction={addTransaction} financeSummary={financeSummary} />}
              {activeTab === 'plan' && <PlanView yearlyScript={yearlyScript} setYearlyScript={setYearlyScript} saveGoals={saveGoals} />}
            </div>
            <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
          </div>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>